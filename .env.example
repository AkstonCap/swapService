# USDC ↔ USDD Bidirectional Swap Service – example environment
# Copy this file to .env and edit the values for your setup.

# --- Solana (Required) ---
SOLANA_RPC_URL=https://api.mainnet-beta.solana.com
# Path to the vault keypair (JSON array of ints)
VAULT_KEYPAIR=./vault-keypair.json
# Vault USDC token account (SPL token account/ATA), NOT a wallet owner
VAULT_USDC_ACCOUNT=<YOUR_VAULT_USDC_TOKEN_ACCOUNT_ADDRESS>
# Mainnet USDC mint (change if using Devnet)
USDC_MINT=EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v
# Devnet USDC mint: 4zMMC9srt5Ri5X14GAgXhaHii3GnPAEERYPJgZJDncDU
# SOL mint (change if using Devnet)
SOL_MINT=So11111111111111111111111111111111111111112
SOL_MAIN_ACCOUNT=<YOUR_SOL_MAIN_ACCOUNT_ADDRESS>

# --- Decimals (Optional) ---
USDC_DECIMALS=6
USDD_DECIMALS=6

# --- Nexus (Required + Optional) ---
# Path to Nexus CLI (Linux/macOS: chmod +x ./nexus)
NEXUS_CLI_PATH=./nexus
# Optional session token if your Nexus node/CLI requires it (not used by the service directly)
NEXUS_SESSION=<YOUR_NEXUS_SESSION>
# PIN for your Nexus account
NEXUS_PIN=<YOUR_NEXUS_PIN>
# USDD treasury account (token treasury) used by the service (receives USDD when minting)
NEXUS_USDD_TREASURY_ACCOUNT=<YOUR_USDD_TREASURY_ACCOUNT_ADDRESS>
# USDD local account: receives tiny USDD routes and congestion fees from refunds
NEXUS_USDD_LOCAL_ACCOUNT=<YOUR_LOCAL_USDD_ACCOUNT_ADDRESS>
# USDD quarantine account: self-owned USDD account where failed USDD refunds are quarantined
NEXUS_USDD_QUARANTINE_ACCOUNT=<YOUR_USDD_QUARANTINE_ACCOUNT_ADDRESS>
# (Optional) USDD fees account if you mint/route fees separately on Nexus
NEXUS_USDD_FEES_ACCOUNT=<YOUR_USDD_FEES_ACCOUNT_ADDRESS>
# Expected token ticker for validation
NEXUS_TOKEN_NAME=USDD
# RPC host if applicable
NEXUS_RPC_HOST=http://127.0.0.1:<port>

# --- Polling & State (Optional) ---
POLL_INTERVAL=15
# Optional chain-specific poll intervals (override global if set)
# If you want faster Solana responsiveness but slower Nexus (e.g. Nexus 50s blocks), set:
# SOLANA_POLL_INTERVAL=15
# NEXUS_POLL_INTERVAL=55
SOLANA_POLL_INTERVAL=25
NEXUS_POLL_INTERVAL=55
PROCESSED_SIG_FILE=processed_sigs.json
PROCESSED_NEXUS_FILE=processed_nexus_txs.json
ATTEMPT_STATE_FILE=attempt_state.json
FAILED_REFUNDS_FILE=failed_refunds.jsonl
REFUNDED_SIGS_FILE=refunded_sigs.jsonl
MAX_ACTION_ATTEMPTS=3
ACTION_RETRY_COOLDOWN_SEC=300
REFUND_TIMEOUT_SEC=3600
STALE_DEPOSIT_QUARANTINE_SEC=86400

# --- Timeout & Hang Prevention (Optional) ---
# Solana RPC call timeout (seconds)
SOLANA_RPC_TIMEOUT_SEC=8
# Individual transaction fetch timeout (seconds)
SOLANA_TX_FETCH_TIMEOUT_SEC=12
# Max time budget for Solana poller per cycle (seconds)
SOLANA_POLL_TIME_BUDGET_SEC=15
# Max transactions to fetch per Solana poll cycle
SOLANA_MAX_TX_FETCH_PER_POLL=40
# Nexus CLI command timeout (seconds)
NEXUS_CLI_TIMEOUT_SEC=20
# Max time budget for Nexus poller per cycle (seconds)
NEXUS_POLL_TIME_BUDGET_SEC=15
# Max time for metrics collection (seconds)
METRICS_BUDGET_SEC=5
# How often to show metrics (seconds)
METRICS_INTERVAL_SEC=30
# Age threshold for stale rows to be quarantined/manual review (seconds)
STALE_ROW_SEC=86400

# --- Fees & policy ---
# Flat fee for USDC→USDD (charged per refund attempt if refunding)
FLAT_FEE_USDC=0.1
# Threshold for tiny USDD deposits; tiny USDD goes to NEXUS_USDD_LOCAL_ACCOUNT
FLAT_FEE_USDD=0.1
# Single dynamic fee (bps) applied on successful swaps (both directions). Set to 0 to disable.
DYNAMIC_FEE_BPS=10

# Nexus congestion fee (USDD token units) subtracted from USDD refunds on the Nexus->Solana path
# This covers on-chain execution costs for rejected/invalid deposits (e.g., invalid Solana address)
NEXUS_CONGESTION_FEE_USDD=0.01

# --- Fee processing / maintenance ---
# Enable optional DEX SOL top-ups and backing checks (disabled by default)
FEE_CONVERSION_ENABLED=false
# Minimum USDC base units before attempting conversions (e.g., 100000 = 0.1 USDC when USDC_DECIMALS=6)
FEE_CONVERSION_MIN_USDC=100000
# SOL lamports thresholds (min to trigger buy; target to top up to)
SOL_TOPUP_MIN_LAMPORTS=5000000
SOL_TOPUP_TARGET_LAMPORTS=10000000
# Optional: minimum NXS units before attempting NXS top-ups (placeholder)
NEXUS_NXS_TOPUP_MIN=0
# Backing safety thresholds
BACKING_DEFICIT_BPS_ALERT=10
BACKING_DEFICIT_PAUSE_PCT=90
# Periodic reconcile: (optional) mint USDD to local account to bring backing to 1:1
BACKING_RECONCILE_INTERVAL_SEC=3600
# If neither SOL nor NXS are below minimum and backing ratio >= 1.05, mint USDD from treasury to local
# to bring ratio back to 1 only when vault USDC balance is above this threshold (in USDC units)
BACKING_SURPLUS_MINT_THRESHOLD_USDC=20

# --- Optional on-chain heartbeat ---
HEARTBEAT_ENABLED=true
# If you created a heartbeat asset, set its address here; leave blank to disable
NEXUS_HEARTBEAT_ASSET_ADDRESS=
# Asset name for the heartbeat asset (e.g., "USDD Heartbeat")
NEXUS_HEARTBEAT_ASSET_NAME=<YOUR_HEARTBEAT_ASSET_NAME>
# Free if >= 10 seconds between updates
HEARTBEAT_MIN_INTERVAL_SEC=300
## Optional heartbeat waterline fields (used by pollers to bound reprocessing)
HEARTBEAT_WATERLINE_ENABLED=true
HEARTBEAT_WATERLINE_SOLANA_FIELD=last_safe_timestamp_solana
HEARTBEAT_WATERLINE_NEXUS_FIELD=last_safe_timestamp_usdd
HEARTBEAT_WATERLINE_SAFETY_SEC=120

# --- Confirmation / aging thresholds (Optional) ---
# Max seconds to wait for confirming outbound USDD->USDC USDC transfers before refunding
USDC_CONFIRM_TIMEOUT_SEC=600

# --- Quarantine (Optional) ---
# Self-owned USDC token account used to quarantine amounts from failed refunds so they don't affect backing ratio
USDC_QUARANTINE_ACCOUNT=
